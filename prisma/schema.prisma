// prisma/schema.prisma
datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                      String    @id @default(uuid())
  fullName                String
  phoneNumber             String    @unique
  parentPhoneNumber       String
  hashedPassword          String?
  image                   String?
  role                    String    @default("USER")
  balance                 Float     @default(0)
  curriculum              String?
  grade                   String?
  division                String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  courses                 Course[]
  purchases               Purchase[]
  userProgress            UserProgress[]
  balanceTransactions     BalanceTransaction[]
  quizResults             QuizResult[]
  createdPurchaseCodes    PurchaseCode[] @relation("CodeCreator")
  usedPurchaseCodes       PurchaseCode[] @relation("CodeUser")
}

model Course {
  id String @id @default(uuid())
  userId String
  title String @db.Text
  description String? @db.Text
  imageUrl String? @db.Text
  price Float?
  isPublished Boolean @default(false)
  grade String?
  divisions String[]
  subject String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  attachments Attachment[]
  chapters Chapter[]
  purchases Purchase[]
  quizzes Quiz[]
  purchaseCodes PurchaseCode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grade])
  @@index([subject])
}

model Attachment {
  id String @id @default(uuid())
  name String
  url String @db.Text

  courseId String
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model Chapter {
  id String @id @default(uuid())
  title String @db.Text
  description String? @db.Text
  videoUrl String? @db.Text
  videoType String? @default("UPLOAD") // "UPLOAD" or "YOUTUBE"
  youtubeVideoId String? // Store YouTube video ID
  documentUrl String? @db.Text // Store document URL (legacy - for backward compatibility)
  documentName String? // Store original document filename (legacy - for backward compatibility)
  position Int
  isPublished Boolean @default(false)
  isFree Boolean @default(false)

  courseId String
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  userProgress UserProgress[]
  attachments ChapterAttachment[] // New relation for multiple documents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model ChapterAttachment {
  id String @id @default(uuid())
  name String
  url String @db.Text
  position Int @default(0)

  chapterId String
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chapterId])
}

model UserProgress {
    id        String   @id @default(uuid())
    userId    String
    chapterId String
    isCompleted Boolean @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

    @@unique([userId, chapterId])
    @@index([chapterId])
}

model Purchase {
    id String @id @default(uuid())
    userId String
    courseId String
    status String @default("ACTIVE")
    purchaseCodeId String? // Reference to the code used, if any
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    purchaseCode PurchaseCode? @relation(fields: [purchaseCodeId], references: [id], onDelete: SetNull)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, courseId])
    @@index([courseId])
    @@index([purchaseCodeId])
}

model PurchaseCode {
    id String @id @default(uuid())
    code String @unique // Unique code for redemption
    courseId String
    createdBy String // User ID of teacher/admin who created it
    usedBy String? // User ID who used the code
    usedAt DateTime? // When the code was used
    isUsed Boolean @default(false)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    creator User @relation("CodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)
    user User? @relation("CodeUser", fields: [usedBy], references: [id], onDelete: SetNull)
    purchases Purchase[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([courseId])
    @@index([code])
    @@index([createdBy])
    @@index([isUsed])
}

model BalanceTransaction {
    id String @id @default(uuid())
    userId String
    amount Float
    type String // "DEPOSIT" or "PURCHASE"
    description String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
}

model Quiz {
    id String @id @default(uuid())
    title String
    description String? @db.Text
    position Int
    isPublished Boolean @default(false)
    timer Int? // Timer in minutes, null means no time limit
    maxAttempts Int @default(1) // Maximum number of attempts allowed
    courseId String
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    questions Question[]
    quizResults QuizResult[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([courseId])
}

model Question {
    id String @id @default(uuid())
    text String @db.Text
    type String // "MULTIPLE_CHOICE", "TRUE_FALSE", "SHORT_ANSWER"
    options String? @db.Text // JSON string for multiple choice options
    correctAnswer String @db.Text
    points Int @default(1)
    imageUrl String? @db.Text
    position Int @default(1)
    quizId String
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers QuizAnswer[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([quizId])
}

model QuizResult {
    id String @id @default(uuid())
    studentId String
    quizId String
    score Int
    totalPoints Int
    percentage Float
    attemptNumber Int @default(1) // Track which attempt this is
    submittedAt DateTime @default(now())
    user User @relation(fields: [studentId], references: [id], onDelete: Cascade)
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers QuizAnswer[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([studentId, quizId])
    @@index([quizId])
}

model QuizAnswer {
    id String @id @default(uuid())
    questionId String
    quizResultId String
    studentAnswer String @db.Text
    correctAnswer String @db.Text
    isCorrect Boolean
    pointsEarned Int
    question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
    quizResult QuizResult @relation(fields: [quizResultId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([questionId])
    @@index([quizResultId])
}